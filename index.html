<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bible Wheel Game</title>
    <style>
        :root {
            --bg-color: #2c3e50;
            --text-color: white;
            --accent-color: #f1c40f;
            --btn-hover: #f39c12;
            --wheel-border: #ecf0f1;
            --selected-color: #2ecc71;
            --team-active: #e74c3c;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- Fullscreen Btn --- */
        .fullscreen-btn {
            position: fixed;
            top: 20px;
            left: 20px; /* Will flip in RTL */
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 10px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            z-index: 1000;
            font-size: 1.2rem;
        }
        [dir="rtl"] .fullscreen-btn { left: 20px; right: auto; }
        [dir="ltr"] .fullscreen-btn { right: 20px; left: auto; }

        /* --- Screens --- */
        .screen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
            overflow-y: auto;
        }

        /* --- 1. Language Screen --- */
        #langScreen { display: flex; } /* Initial Screen */
        
        .lang-btn {
            background: white;
            color: var(--bg-color);
            border: none;
            padding: 20px 40px;
            margin: 10px;
            font-size: 1.5rem;
            border-radius: 50px;
            cursor: pointer;
            width: 80%;
            max-width: 300px;
            font-weight: bold;
            transition: transform 0.2s;
        }
        .lang-btn:hover { transform: scale(1.05); background: var(--accent-color); color: white; }

        /* --- 2. Intro Screen --- */
        h1 { font-size: 2rem; margin-bottom: 5px; color: var(--accent-color); text-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .section-title { margin-top: 20px; margin-bottom: 10px; font-size: 1.1rem; color: #bdc3c7; border-bottom: 1px solid #7f8c8d; padding-bottom: 5px; width: 100%; max-width: 400px; }
        
        .team-select-grid { display: flex; gap: 10px; margin-bottom: 20px; }
        .team-btn { background: transparent; border: 2px solid #7f8c8d; color: #bdc3c7; width: 50px; height: 50px; border-radius: 50%; font-size: 1.2rem; cursor: pointer; transition: all 0.2s; }
        .team-btn.selected { background: var(--accent-color); color: var(--bg-color); border-color: var(--accent-color); font-weight: bold; transform: scale(1.1); }

        .group-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 100%; max-width: 500px; margin-bottom: 25px; }
        .group-btn { background: white; color: var(--bg-color); border: 3px solid transparent; padding: 12px; font-size: 1rem; border-radius: 12px; cursor: pointer; font-weight: bold; opacity: 0.8; transition: all 0.2s; }
        .group-btn:hover { opacity: 1; transform: translateY(-2px); }
        .group-btn.selected { border-color: var(--selected-color); background: #e8f8f5; color: #27ae60; opacity: 1; }

        .start-game-btn { background: var(--accent-color); color: var(--bg-color); border: none; padding: 15px 60px; font-size: 1.5rem; border-radius: 50px; cursor: pointer; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.3); transition: transform 0.2s; }
        .start-game-btn:disabled { background: #7f8c8d; cursor: not-allowed; opacity: 0.5; }

        /* --- 3. Game Screen --- */
        #gameScreen { position: relative; }
        .scoreboard { position: absolute; top: 0; left: 0; width: 100%; display: flex; justify-content: space-around; padding: 10px 5px; background: rgba(0,0,0,0.3); backdrop-filter: blur(5px); z-index: 30; box-sizing: border-box; }
        .team-card { background: rgba(255,255,255,0.1); border-radius: 10px; padding: 5px 10px; text-align: center; border: 2px solid transparent; transition: all 0.3s; flex: 1; margin: 0 5px; max-width: 100px; }
        .team-card.active-turn { background: white; color: var(--bg-color); border-color: var(--accent-color); transform: scale(1.05); box-shadow: 0 0 15px rgba(241, 196, 15, 0.5); }
        .team-name { font-size: 0.8rem; display: block; }
        .team-score { font-size: 1.2rem; font-weight: bold; }

        .wheel-container { position: relative; width: 75vmin; height: 75vmin; max-width: 500px; max-height: 500px; margin-top: 60px; margin-bottom: 10px; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.4)); }
        canvas { width: 100%; height: 100%; border-radius: 50%; }
        .pointer { position: absolute; top: -25px; left: 50%; transform: translateX(-50%); width: 50px; height: 50px; background: #e74c3c; clip-path: polygon(50% 100%, 0 0, 100% 0); z-index: 10; }

        .controls { display: flex; flex-direction: column; align-items: center; z-index: 20; }
        button.spin-btn { padding: 12px 40px; font-size: 1.3rem; border: none; border-radius: 50px; background: var(--accent-color); color: var(--bg-color); font-weight: bold; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        button.spin-btn:disabled { background: #95a5a6; }

        /* --- Modal --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .modal-box { background: white; color: var(--bg-color); padding: 25px; border-radius: 20px; width: 100%; max-width: 500px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); max-height: 90vh; overflow-y: auto; }
        .question-text { font-size: 1.4rem; margin: 20px 0; font-weight: bold; }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .opt-btn { padding: 12px; border: 2px solid #bdc3c7; background: white; border-radius: 10px; font-size: 1rem; cursor: pointer; color: var(--bg-color); }
        .reference-box { display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-right: 5px solid #2ecc71; text-align: right; }
        [dir="ltr"] .reference-box { border-right: none; border-left: 5px solid #2ecc71; text-align: left; }
        
        .action-btn { width:auto; height:auto; padding:10px 30px; background:#2c3e50; color:white; border:none; border-radius:10px; margin-top:15px; cursor: pointer; font-size: 1rem; }

        /* --- Game Over --- */
        .winner-box { background: linear-gradient(135deg, #f1c40f, #f39c12); color: #2c3e50; padding: 30px; border-radius: 20px; text-align: center; width: 90%; max-width: 400px; animation: popIn 0.5s ease; }
        .rank-list { list-style: none; padding: 0; margin-top: 20px; text-align: inherit; }
        .rank-item { background: rgba(255,255,255,0.3); margin: 5px 0; padding: 10px; border-radius: 8px; display: flex; justify-content: space-between; font-weight: bold; }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Landscape Mobile */
        @media (max-height: 500px) and (orientation: landscape) {
            #gameScreen { flex-direction: row; align-items: center; }
            .scoreboard { width: 150px; height: 100%; top:0; left:0; flex-direction: column; justify-content: center; }
            [dir="ltr"] .scoreboard { left: auto; right: 0; }
            .wheel-container { margin-top: 0; margin-left: 160px; height: 85vmin; width: 85vmin; }
            [dir="ltr"] .wheel-container { margin-left: 0; margin-right: 160px; }
            .controls { position: absolute; bottom: 20px; right: 20px; }
            [dir="ltr"] .controls { right: auto; left: 20px; }
        }
    </style>
</head>
<body>

    <button class="fullscreen-btn" onclick="toggleFullScreen()" title="Toggle Fullscreen">‚õ∂</button>

    <div id="langScreen" class="screen">
        <h1 style="margin-bottom: 40px;">‚úü Bible Quiz</h1>
        <button class="lang-btn" onclick="setLanguage('ar')">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</button>
        <button class="lang-btn" onclick="setLanguage('en')">English</button>
        <button class="lang-btn" onclick="setLanguage('fr')">Fran√ßais</button>
    </div>

    <div id="introScreen" class="screen">
        <h1 id="ui-title">ŸÖÿ≥ÿßÿ®ŸÇÿ© ÿßŸÑŸÉÿ™ÿßÿ® ÿßŸÑŸÖŸÇÿØÿ≥</h1>
        
        <div class="section-title" id="ui-teams">ÿπÿØÿØ ÿßŸÑŸÅÿ±ŸÇ</div>
        <div class="team-select-grid">
            <button class="team-btn selected" onclick="selectTeams(1)">1</button>
            <button class="team-btn" onclick="selectTeams(2)">2</button>
            <button class="team-btn" onclick="selectTeams(3)">3</button>
            <button class="team-btn" onclick="selectTeams(4)">4</button>
        </div>

        <div class="section-title" id="ui-groups">ŸÖÿ¨ŸÖŸàÿπÿ© ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ©</div>
        <div class="group-grid">
            <button class="group-btn" id="btn-1" onclick="toggleGroup(1)">1</button>
            <button class="group-btn" id="btn-2" onclick="toggleGroup(2)">2</button>
            <button class="group-btn" id="btn-3" onclick="toggleGroup(3)">3</button>
            <button class="group-btn" id="btn-4" onclick="toggleGroup(4)">4</button>
        </div>

        <button class="start-game-btn" id="startBtn" onclick="confirmStart()" disabled>ÿßÿ®ÿØÿ£ ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿ©</button>
    </div>

    <div id="gameScreen" class="screen">
        <div class="scoreboard" id="scoreboard"></div>

        <div class="wheel-container">
            <div class="pointer"></div>
            <canvas id="wheelCanvas" width="1000" height="1000"></canvas>
        </div>

        <div class="controls">
            <div id="turnMsg" style="color:var(--accent-color); margin-bottom:10px; font-weight:bold;"></div>
            <button class="spin-btn" id="spinBtn" onclick="spin()">SPIN!</button>
            <button class="action-btn" id="endBtn" style="background:transparent; border:1px solid #7f8c8d; color:#bdc3c7; margin-top:10px; padding: 5px 15px;" onclick="location.reload()">End Game</button>
        </div>
    </div>

    <div class="modal-overlay" id="modal">
        <div class="modal-box">
            <span id="mLevel" style="padding: 5px 12px; border-radius: 12px; color: white; font-size: 0.8rem;"></span>
            <div class="question-text" id="mQuestion">...</div>
            <div class="options-grid" id="mOptions"></div>
            <div class="reference-box" id="mReference"></div>
            <button class="action-btn" id="closeBtn" style="display:none;" onclick="closeModal()">Next</button>
        </div>
    </div>

    <div class="modal-overlay" id="gameOverModal">
        <div class="winner-box">
            <h2 style="margin:0; font-size:2rem;" id="ui-results">üèÜ Results</h2>
            <div id="winnerName" style="font-size:1.5rem; margin:15px 0; font-weight:bold;"></div>
            <ul class="rank-list" id="rankList"></ul>
            <button class="action-btn" style="background:white; color:#2c3e50; font-weight:bold; margin-top:20px;" onclick="location.reload()" id="ui-newgame">New Game</button>
        </div>
    </div>

    <script src="questions.js"></script>

    <script>
        // =====================================
        // TRANSLATION DATA
        // =====================================
        const translations = {
            ar: {
                title: "ŸÖÿ≥ÿßÿ®ŸÇÿ© ÿßŸÑŸÉÿ™ÿßÿ® ÿßŸÑŸÖŸÇÿØÿ≥",
                teams: "ÿπÿØÿØ ÿßŸÑŸÅÿ±ŸÇ ÿßŸÑŸÖÿ™ŸÜÿßŸÅÿ≥ÿ©",
                groups: "ŸÖÿ¨ŸÖŸàÿπÿ© ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ©",
                start: "ÿßÿ®ÿØÿ£ ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿ©",
                selectGroup: "ÿßÿÆÿ™ÿ± ŸÖÿ¨ŸÖŸàÿπÿ©",
                spin: "ÿØŸàŸëÿ± ÿßŸÑÿπÿ¨ŸÑÿ©!",
                end: "ÿÆÿ±Ÿàÿ¨",
                turn: "ÿØŸàÿ± ÿßŸÑŸÅÿ±ŸäŸÇ",
                team: "ÿßŸÑŸÅÿ±ŸäŸÇ",
                next: "ÿßŸÑÿ™ÿßŸÑŸä",
                ref: "ÿßŸÑÿ¥ÿßŸáÿØ:",
                results: "ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑŸÜŸáÿßÿ¶Ÿäÿ©",
                winner: "ÿßŸÑŸÅÿßÿ¶ÿ≤",
                newgame: "ŸÑÿπÿ®ÿ© ÿ¨ÿØŸäÿØÿ©",
                levels: {1:"ÿ≥ŸáŸÑ", 2:"ŸÖÿ™Ÿàÿ≥ÿ∑", 3:"ÿµÿπÿ®", 4:"ÿÆÿ®Ÿäÿ±"},
                groupNames: ["ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ 1 (1-25)", "ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ 2 (26-50)", "ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ 3 (51-75)", "ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ 4 (76-100)"]
            },
            en: {
                title: "Bible Quiz",
                teams: "Number of Teams",
                groups: "Question Groups",
                start: "Start Game",
                selectGroup: "Select Group",
                spin: "Spin Wheel!",
                end: "Exit",
                turn: "Team Turn:",
                team: "Team",
                next: "Next",
                ref: "Reference:",
                results: "Final Results",
                winner: "Winner",
                newgame: "New Game",
                levels: {1:"Easy", 2:"Medium", 3:"Hard", 4:"Expert"},
                groupNames: ["Level 1 (1-25)", "Level 2 (26-50)", "Level 3 (51-75)", "Level 4 (76-100)"]
            },
            fr: {
                title: "Quiz Biblique",
                teams: "Nombre d'√©quipes",
                groups: "Groupes de questions",
                start: "Commencer",
                selectGroup: "Choisir un groupe",
                spin: "Tournez la roue !",
                end: "Quitter",
                turn: "Tour de l'√©quipe",
                team: "√âquipe",
                next: "Suivant",
                ref: "R√©f√©rence:",
                results: "R√©sultats finaux",
                winner: "Gagnant",
                newgame: "Nouvelle partie",
                levels: {1:"Facile", 2:"Moyen", 3:"Difficile", 4:"Expert"},
                groupNames: ["Niveau 1 (1-25)", "Niveau 2 (26-50)", "Niveau 3 (51-75)", "Niveau 4 (76-100)"]
            }
        };

        // =====================================
        // STATE
        // =====================================
        let currentLang = 'ar';
        let allQuestions = []; // Loaded from gameData based on lang
        let currentQuestions = [];
        let selectedGroups = new Set();
        let numTeams = 1;
        let scores = [0, 0, 0, 0];
        let currentTeamIndex = 0;
        let audioCtx = null;
        
        const levelColors = { 1: "#2ecc71", 2: "#f1c40f", 3: "#e67e22", 4: "#e74c3c" };

        // =====================================
        // 1. LANGUAGE & SETUP
        // =====================================
        function setLanguage(lang) {
            currentLang = lang;
            
            // 1. Set Direction
            const dir = (lang === 'ar') ? 'rtl' : 'ltr';
            document.documentElement.setAttribute('dir', dir);
            document.documentElement.setAttribute('lang', lang);

            // 2. Load Data
            if (typeof gameData !== 'undefined' && gameData[lang]) {
                allQuestions = JSON.parse(JSON.stringify(gameData[lang]));
            } else {
                alert("Error: Questions for this language not found in questions.js");
                return;
            }

            // 3. Update UI Text
            const t = translations[lang];
            document.getElementById('ui-title').innerText = t.title;
            document.getElementById('ui-teams').innerText = t.teams;
            document.getElementById('ui-groups').innerText = t.groups;
            document.getElementById('startBtn').innerText = t.selectGroup; // Initially disabled
            document.getElementById('spinBtn').innerText = t.spin;
            document.getElementById('endBtn').innerText = t.end;
            document.getElementById('closeBtn').innerText = t.next;
            document.getElementById('ui-results').innerText = t.results;
            document.getElementById('ui-newgame').innerText = t.newgame;

            // Update Group Buttons Text
            document.getElementById('btn-1').innerText = t.groupNames[0];
            document.getElementById('btn-2').innerText = t.groupNames[1];
            document.getElementById('btn-3').innerText = t.groupNames[2];
            document.getElementById('btn-4').innerText = t.groupNames[3];

            // 4. Switch Screen
            document.getElementById('langScreen').style.display = 'none';
            document.getElementById('introScreen').style.display = 'flex';
        }

        // =====================================
        // 2. SELECTION LOGIC
        // =====================================
        function selectTeams(n) {
            numTeams = n;
            const btns = document.querySelectorAll('.team-select-grid .team-btn');
            btns.forEach((b, i) => {
                if (i + 1 === n) b.classList.add('selected');
                else b.classList.remove('selected');
            });
        }

        function toggleGroup(id) {
            const btn = document.getElementById(`btn-${id}`);
            if (selectedGroups.has(id)) {
                selectedGroups.delete(id);
                btn.classList.remove('selected');
            } else {
                selectedGroups.add(id);
                btn.classList.add('selected');
            }
            
            const startBtn = document.getElementById('startBtn');
            const t = translations[currentLang];
            startBtn.disabled = (selectedGroups.size === 0);
            startBtn.innerText = selectedGroups.size > 0 ? t.start : t.selectGroup;
        }

        function confirmStart() {
            // Filter
            currentQuestions = allQuestions.filter(q => {
                let g = 0;
                if (q.id <= 25) g = 1;
                else if (q.id <= 50) g = 2;
                else if (q.id <= 75) g = 3;
                else if (q.id <= 100) g = 4;
                return selectedGroups.has(g);
            });

            if(currentQuestions.length === 0) return;

            // Init Game
            scores = new Array(numTeams).fill(0);
            currentTeamIndex = 0;
            
            // Build Scoreboard
            const sb = document.getElementById('scoreboard');
            sb.innerHTML = '';
            const t = translations[currentLang];
            for(let i=0; i<numTeams; i++) {
                sb.innerHTML += `
                    <div class="team-card" id="team-card-${i}">
                        <span class="team-name">${t.team} ${i+1}</span>
                        <span class="team-score" id="score-${i}">0</span>
                    </div>
                `;
            }

            // Show Game
            document.getElementById('introScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'flex';
            
            updateTurnUI();
            drawWheel();
        }

        function updateTurnUI() {
            for(let i=0; i<numTeams; i++) {
                const card = document.getElementById(`team-card-${i}`);
                if(i === currentTeamIndex) card.classList.add('active-turn');
                else card.classList.remove('active-turn');
            }
            const t = translations[currentLang];
            document.getElementById('turnMsg').innerText = `${t.turn}: ${t.team} ${currentTeamIndex + 1}`;
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(e=>{});
            else if (document.exitFullscreen) document.exitFullscreen();
        }

        // =====================================
        // 3. WHEEL LOGIC
        // =====================================
        const canvas = document.getElementById('wheelCanvas');
        const ctx = canvas.getContext('2d');
        const size = 1000; const center = size/2; const radius = size/2 - 20;
        let currentDeg = 0;
        let selectedIndex = -1;

        function drawWheel() {
            if (currentQuestions.length === 0) {
                showGameOver();
                return;
            }

            const sliceDeg = 360 / currentQuestions.length;
            const sliceRad = (sliceDeg * Math.PI) / 180;
            ctx.clearRect(0, 0, size, size);

            // Correct rotation for RTL vs LTR to ensure text isn't upside down if we render text
            // But we render just numbers.
            
            for (let i = 0; i < currentQuestions.length; i++) {
                const q = currentQuestions[i];
                const startAngle = (i * sliceRad) - (Math.PI / 2);
                ctx.beginPath();
                ctx.moveTo(center, center);
                ctx.arc(center, center, radius, startAngle, startAngle + sliceRad);
                ctx.closePath();
                ctx.fillStyle = levelColors[q.l];
                ctx.fill();
                ctx.strokeStyle = "#2c3e50"; ctx.lineWidth = 2; ctx.stroke();
                
                // Render Number
                if(currentQuestions.length <= 60) {
                    ctx.save();
                    ctx.translate(center, center);
                    ctx.rotate(startAngle + sliceRad / 2);
                    ctx.textAlign = "right";
                    ctx.fillStyle = "rgba(0,0,0,0.5)"; 
                    ctx.font = "bold 24px Arial";
                    ctx.fillText(q.id, radius - 28, 12);
                    ctx.fillStyle = "#fff"; 
                    ctx.fillText(q.id, radius - 30, 10);
                    ctx.restore();
                }
            }
        }

        function spin() {
            if (currentQuestions.length === 0) return;
            initAudio();
            document.getElementById('spinBtn').disabled = true;
            
            const winnerIdx = Math.floor(Math.random() * currentQuestions.length);
            const winner = currentQuestions[winnerIdx];
            selectedIndex = winnerIdx;

            const sliceDeg = 360 / currentQuestions.length;
            const targetDeg = (winnerIdx * sliceDeg); 
            const randomOffset = (Math.random() * sliceDeg * 0.8) - (sliceDeg * 0.4);
            const totalDeg = currentDeg + 1800 + (360 - targetDeg - (currentDeg % 360) + 360)%360 + randomOffset;

            canvas.style.transform = `rotate(${totalDeg}deg)`;
            canvas.style.transition = "transform 4s cubic-bezier(0.25, 0.1, 0.25, 1)";
            currentDeg = totalDeg;

            let duration = 4000; let start = Date.now();
            function tick() {
                if(Date.now()-start > duration) return;
                playTick();
                setTimeout(tick, 50 + ((Date.now()-start)/duration)**2 * 500);
            }
            tick();

            setTimeout(() => {
                openQuestion(winner); 
                document.getElementById('spinBtn').disabled = false;
            }, 4000);
        }

        // =====================================
        // 4. MODAL LOGIC
        // =====================================
        function openQuestion(q) {
            const modal = document.getElementById('modal');
            const t = translations[currentLang];
            
            document.getElementById('mLevel').innerText = `${t.levels[q.l]}`;
            document.getElementById('mLevel').style.background = levelColors[q.l];
            document.getElementById('mQuestion').innerText = q.t;
            
            const optDiv = document.getElementById('mOptions');
            optDiv.innerHTML = "";
            document.getElementById('mReference').style.display = 'none';
            document.getElementById('closeBtn').style.display = 'none';

            let opts = q.o.map((txt, i) => ({ t: txt, c: (i === q.c) }));
            // Shuffle
            for (let i = opts.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [opts[i], opts[j]] = [opts[j], opts[i]];
            }

            opts.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "opt-btn";
                btn.innerText = opt.t;
                btn.onclick = () => handleAnswer(btn, opt.c, q.r);
                optDiv.appendChild(btn);
            });

            modal.style.display = 'flex';
        }

        function handleAnswer(btn, isCorrect, ref) {
            const allBtns = document.querySelectorAll('.opt-btn');
            allBtns.forEach(b => b.disabled = true);

            if(isCorrect) {
                playWin();
                btn.style.background = "#2ecc71"; btn.style.color = "white"; btn.style.borderColor = "#27ae60";
                scores[currentTeamIndex]++;
                document.getElementById(`score-${currentTeamIndex}`).innerText = scores[currentTeamIndex];
            } else {
                playLoss();
                btn.style.background = "#e74c3c"; btn.style.color = "white"; btn.style.borderColor = "#c0392b";
            }

            const refBox = document.getElementById('mReference');
            const t = translations[currentLang];
            refBox.innerHTML = `<strong>${t.ref}</strong><br>${ref}`;
            refBox.style.display = 'block';
            document.getElementById('closeBtn').style.display = 'inline-block';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            if (selectedIndex !== -1) {
                currentQuestions.splice(selectedIndex, 1);
                selectedIndex = -1;
            }
            currentTeamIndex++;
            if(currentTeamIndex >= numTeams) currentTeamIndex = 0;
            updateTurnUI();
            drawWheel();
        }

        // =====================================
        // 5. GAME OVER
        // =====================================
        function showGameOver() {
            const modal = document.getElementById('gameOverModal');
            const list = document.getElementById('rankList');
            list.innerHTML = "";
            const t = translations[currentLang];

            let ranking = scores.map((s, i) => ({ id: i+1, score: s }));
            ranking.sort((a, b) => b.score - a.score);

            document.getElementById('winnerName').innerText = `üéâ ${t.winner}: ${t.team} ${ranking[0].id} üéâ`;

            ranking.forEach((r, idx) => {
                let badge = idx === 0 ? "ü•á" : (idx === 1 ? "ü•à" : (idx === 2 ? "ü•â" : ""));
                list.innerHTML += `
                    <li class="rank-item">
                        <span>${badge} ${t.team} ${r.id}</span>
                        <span>${r.score}</span>
                    </li>
                `;
            });

            modal.style.display = 'flex';
            playWin();
        }

        // =====================================
        // 6. AUDIO
        // =====================================
        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }
        function playTone(f, t, d, v=0.1) {
            if(!audioCtx) return;
            const o=audioCtx.createOscillator(), g=audioCtx.createGain();
            o.type=t; o.frequency.value=f; g.gain.setValueAtTime(v, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime+d);
            o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+d);
        }
        function playTick() { playTone(300,'square',0.05,0.05); }
        function playWin() { 
            playTone(523.25,'sine',0.4,0.2); setTimeout(()=>playTone(659.25,'sine',0.4,0.2),100);
            setTimeout(()=>playTone(783.99,'sine',0.6,0.2),200); setTimeout(()=>playTone(1046.50,'sine',1.0,0.1),300);
        }
        function playLoss() {
            if(!audioCtx) return;
            const o=audioCtx.createOscillator(), g=audioCtx.createGain();
            o.type='sawtooth'; o.frequency.setValueAtTime(150, audioCtx.currentTime);
            o.frequency.linearRampToValueAtTime(50, audioCtx.currentTime+0.5);
            g.gain.setValueAtTime(0.2, audioCtx.currentTime);
            g.gain.linearRampToValueAtTime(0.001, audioCtx.currentTime+0.5);
            o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.5);
        }
    </script>
</body>
</html>
