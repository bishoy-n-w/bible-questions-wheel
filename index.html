<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bible Wheel - Multi Language</title>
    <style>
        :root {
            --bg-color: #2c3e50;
            --text-color: white;
            --accent-color: #f1c40f;
            --btn-hover: #f39c12;
            --wheel-border: #ecf0f1;
            --selected-color: #2ecc71;
            --card-bg: rgba(255,255,255,0.1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- Version Tag --- */
        .version-tag {
            position: absolute;
            bottom: 10px;
            right: 15px; /* Will flip in RTL */
            font-size: 0.8rem;
            color: rgba(255,255,255,0.3);
            pointer-events: none;
            z-index: 50;
        }
        [dir="rtl"] .version-tag { right: auto; left: 15px; }

        /* --- Fullscreen Btn --- */
        .fullscreen-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 10px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            z-index: 1000;
            font-size: 1.2rem;
        }
        [dir="rtl"] .fullscreen-btn { right: auto; left: 20px; }

        /* --- Screens --- */
        .screen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
            overflow-y: auto;
        }

        /* --- 1. Language Screen --- */
        #langScreen { display: flex; }
        
        .lang-grid {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .lang-toggle {
            background: transparent;
            border: 2px solid #7f8c8d;
            color: #bdc3c7;
            padding: 15px 30px;
            font-size: 1.2rem;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 120px;
        }
        
        .lang-toggle.active {
            background: var(--accent-color);
            color: var(--bg-color);
            border-color: var(--accent-color);
            font-weight: bold;
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(241, 196, 15, 0.4);
        }

        /* --- 2. Intro Screen --- */
        h1 { font-size: 1.8rem; margin-bottom: 5px; color: var(--accent-color); text-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .section-title { margin-top: 15px; margin-bottom: 10px; font-size: 1rem; color: #bdc3c7; border-bottom: 1px solid #7f8c8d; padding-bottom: 5px; width: 100%; max-width: 400px; }
        
        .team-select-grid { display: flex; gap: 10px; margin-bottom: 15px; }
        .team-btn { background: transparent; border: 2px solid #7f8c8d; color: #bdc3c7; width: 45px; height: 45px; border-radius: 50%; font-size: 1.1rem; cursor: pointer; transition: all 0.2s; }
        .team-btn.selected { background: var(--accent-color); color: var(--bg-color); border-color: var(--accent-color); font-weight: bold; transform: scale(1.1); }

        .group-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 100%; max-width: 500px; margin-bottom: 20px; }
        .group-btn { 
            background: white; 
            color: var(--bg-color); 
            border: 3px solid transparent; 
            padding: 15px 10px; 
            font-size: 1rem; 
            border-radius: 12px; 
            cursor: pointer; 
            font-weight: bold; 
            opacity: 0.8; 
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            line-height: 1.4;
        }
        .group-btn:hover { opacity: 1; transform: translateY(-2px); }
        .group-btn.selected { border-color: var(--selected-color); background: #e8f8f5; color: #27ae60; opacity: 1; }
        
        .group-count { font-size: 0.8rem; color: #7f8c8d; font-weight: normal; margin-top: 4px; }

        .action-btn { background: var(--accent-color); color: var(--bg-color); border: none; padding: 15px 50px; font-size: 1.3rem; border-radius: 50px; cursor: pointer; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.3); transition: transform 0.2s; margin-top: 10px;}
        .action-btn:disabled { background: #7f8c8d; cursor: not-allowed; opacity: 0.5; }

        /* --- 3. Game Screen (Default Portrait) --- */
        #gameScreen { position: relative; }
        
        /* Scoreboard: Absolute top in portrait */
        .scoreboard { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            display: flex; 
            justify-content: space-around; 
            padding: 10px 5px; 
            background: rgba(0,0,0,0.3); 
            backdrop-filter: blur(5px); 
            z-index: 30; 
            box-sizing: border-box; 
        }
        
        .team-card { background: rgba(255,255,255,0.1); border-radius: 8px; padding: 5px; text-align: center; border: 2px solid transparent; transition: all 0.3s; flex: 1; margin: 0 4px; max-width: 90px; }
        .team-card.active-turn { background: white; color: var(--bg-color); border-color: var(--accent-color); transform: scale(1.05); box-shadow: 0 0 10px rgba(241, 196, 15, 0.5); }
        .team-name { font-size: 0.75rem; display: block; }
        .team-score { font-size: 1.1rem; font-weight: bold; }

        .wheel-container { 
            position: relative; 
            width: 75vmin; 
            height: 75vmin; 
            max-width: 500px; 
            max-height: 500px; 
            margin-top: 60px; /* Space for scoreboard */
            margin-bottom: 20px; 
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.4)); 
            flex-shrink: 0;
        }
        
        canvas { width: 100%; height: 100%; border-radius: 50%; }
        .pointer { position: absolute; top: -25px; left: 50%; transform: translateX(-50%); width: 40px; height: 40px; background: #e74c3c; clip-path: polygon(50% 100%, 0 0, 100% 0); z-index: 10; }

        /* Controls: Standard flow in portrait */
        .controls { display: flex; flex-direction: column; align-items: center; z-index: 20; }
        
        /* --- Modal (Multi-Language Support) --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; justify-content: center; align-items: center; padding: 15px; box-sizing: border-box; }
        .modal-box { background: white; color: var(--bg-color); padding: 20px; border-radius: 15px; width: 100%; max-width: 600px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; }
        
        .q-container { margin: 15px 0; border-bottom: 2px solid #ecf0f1; padding-bottom: 15px; }
        .q-text-item { font-size: 1.2rem; margin: 8px 0; line-height: 1.4; font-weight: bold; }
        .q-text-item:not(:last-child) { border-bottom: 1px dashed #bdc3c7; padding-bottom: 8px; }
        .q-text-item[lang="ar"] { font-family: 'Segoe UI', Tahoma; font-size: 1.3rem; }
        
        .options-grid { display: grid; grid-template-columns: 1fr; gap: 8px; width: 100%; margin-bottom: 20px; }
        .opt-btn { 
            padding: 10px; 
            border: 2px solid #bdc3c7; 
            background: #f8f9fa; 
            border-radius: 10px; 
            cursor: pointer; 
            color: var(--bg-color); 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60px;
        }
        .opt-subtext { font-size: 0.9rem; margin: 2px 0; width: 100%; }
        .opt-subtext:not(:last-child) { border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 2px; }
        
        /* Reference Box (Bottom) */
        .reference-box { 
            display: none; 
            margin-top: 10px; 
            padding: 15px; 
            background: #ecf0f1; 
            border-radius: 10px;
            text-align: left; 
            font-size: 0.95rem; 
            width: 100%;
            box-sizing: border-box;
            border-top: 4px solid #2ecc71;
        }
        .ref-item { margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid rgba(0,0,0,0.1); }
        .ref-item:last-child { border-bottom: none; margin-bottom: 0; }

        /* --- Game Over --- */
        .winner-box { background: linear-gradient(135deg, #f1c40f, #f39c12); color: #2c3e50; padding: 30px; border-radius: 20px; text-align: center; width: 90%; max-width: 400px; }
        .rank-list { list-style: none; padding: 0; margin-top: 20px; text-align: left; }
        .rank-item { background: rgba(255,255,255,0.3); margin: 5px 0; padding: 10px; border-radius: 8px; display: flex; justify-content: space-between; font-weight: bold; }

        /* =========================================
           LANDSCAPE OPTIMIZATION (NO OVERLAP)
           ========================================= */
        @media (max-height: 500px) and (orientation: landscape) {
            #gameScreen { 
                flex-direction: row; 
                justify-content: space-evenly; /* Spread 3 columns */
                align-items: center;
                padding: 0 10px;
            }

            /* 1. Scoreboard: Moves to side */
            .scoreboard { 
                position: static; /* No longer absolute */
                width: 120px; 
                height: 90vh; 
                flex-direction: column; 
                justify-content: center;
                gap: 10px;
                background: transparent; /* Cleaner look in column */
                backdrop-filter: none;
            }
            .team-card { margin: 5px 0; width: 100%; max-width: none; }

            /* 2. Wheel: Center */
            .wheel-container { 
                margin: 0 10px; 
                height: 70vmin; /* Smaller to prevent overlap */
                width: 70vmin; 
            }

            /* 3. Controls: Move to opposite side */
            .controls {
                width: 120px;
                height: 90vh;
                justify-content: center;
                text-align: center;
            }

            /* Fix Modal for Landscape */
            .modal-box { flex-direction: row; flex-wrap: wrap; max-width: 95vw; justify-content: space-between; padding: 15px;}
            .q-container { width: 100%; margin: 5px 0;}
            .options-grid { width: 48%; }
            .reference-box { width: 48%; margin-top: 0; }
        }
        
        /* PC Optimization (Larger Screens) */
        @media (min-width: 768px) {
            .options-grid { grid-template-columns: 1fr 1fr; }
            .q-text-item { font-size: 1.4rem; }
        }
    </style>
</head>
<body>

    <button class="fullscreen-btn" onclick="toggleFullScreen()" title="Toggle Fullscreen">‚õ∂</button>

    <div id="langScreen" class="screen">
        <h1 style="margin-bottom: 10px;">Bible Quiz</h1>
        <div class="version-tag" style="position:static; margin-bottom: 20px; color:#f1c40f;">v2.0</div>
        
        <p style="color:#bdc3c7; margin-bottom:30px;">Select Language(s) / ÿßÿÆÿ™ÿ± ÿßŸÑŸÑÿ∫ÿ©</p>
        
        <div class="lang-grid">
            <button class="lang-toggle active" id="lang-ar" onclick="toggleLang('ar')">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</button>
            <button class="lang-toggle" id="lang-en" onclick="toggleLang('en')">English</button>
            <button class="lang-toggle" id="lang-fr" onclick="toggleLang('fr')">Fran√ßais</button>
        </div>

        <button class="action-btn" onclick="goToIntro()">Continue ‚û°</button>
    </div>

    <div id="introScreen" class="screen">
        <div class="version-tag">v2.0</div>
        <h1 id="ui-title">Settings</h1>
        
        <div class="section-title" id="ui-teams">Teams</div>
        <div class="team-select-grid">
            <button class="team-btn selected" onclick="selectTeams(1)">1</button>
            <button class="team-btn" onclick="selectTeams(2)">2</button>
            <button class="team-btn" onclick="selectTeams(3)">3</button>
            <button class="team-btn" onclick="selectTeams(4)">4</button>
        </div>

        <div class="section-title" id="ui-groups">Select Level</div>
        <div class="group-grid">
            <button class="group-btn" id="btn-1" onclick="toggleGroup(1)">Level 1</button>
            <button class="group-btn" id="btn-2" onclick="toggleGroup(2)">Level 2</button>
            <button class="group-btn" id="btn-3" onclick="toggleGroup(3)">Level 3</button>
            <button class="group-btn" id="btn-4" onclick="toggleGroup(4)">Level 4</button>
        </div>

        <button class="action-btn" id="startBtn" onclick="confirmStart()" disabled>Start Game</button>
        <button style="background:transparent; border:none; color:#7f8c8d; margin-top:10px; cursor:pointer;" onclick="location.reload()">‚¨Ö Back</button>
    </div>

    <div id="gameScreen" class="screen">
        <div class="version-tag">v2.0</div>
        <div class="scoreboard" id="scoreboard"></div>

        <div class="wheel-container">
            <div class="pointer"></div>
            <canvas id="wheelCanvas" width="1000" height="1000"></canvas>
        </div>

        <div class="controls">
            <div id="turnMsg" style="color:var(--accent-color); margin-bottom:10px; font-weight:bold;"></div>
            <button class="action-btn" id="spinBtn" onclick="spin()">SPIN</button>
        </div>
    </div>

    <div class="modal-overlay" id="modal">
        <div class="modal-box">
            <span id="mLevel" style="padding: 3px 10px; border-radius: 12px; color: white; font-size: 0.8rem; align-self:center; margin-bottom:5px;">Level</span>
            
            <div class="q-container" id="mQuestionContainer"></div>

            <div class="options-grid" id="mOptions"></div>

            <div class="reference-box" id="mReference"></div>
            
            <button class="action-btn" id="closeBtn" style="display:none; align-self: center; margin-top:10px; font-size:1rem; padding: 10px 40px;" onclick="closeModal()">Next ‚û°</button>
        </div>
    </div>

    <div class="modal-overlay" id="gameOverModal">
        <div class="winner-box">
            <h2 style="margin:0; font-size:2rem;" id="ui-results">üèÜ Results</h2>
            <div id="winnerName" style="font-size:1.5rem; margin:15px 0; font-weight:bold;"></div>
            <ul class="rank-list" id="rankList"></ul>
            <button class="action-btn" style="background:white; color:#2c3e50; font-weight:bold; margin-top:20px;" onclick="location.reload()">New Game</button>
        </div>
    </div>

    <script src="questions.js"></script>

    <script>
        // =====================================
        // TRANSLATION STRINGS
        // =====================================
        const uiText = {
            ar: { settings: "ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™", teams: "ÿßŸÑŸÅÿ±ŸÇ", groups: "ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ", start: "ÿßÿ®ÿØÿ£", spin: "ÿØŸàŸëÿ±", turn: "ÿØŸàÿ±", team: "ŸÅÿ±ŸäŸÇ", results: "ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨", easy:"ÿ≥ŸáŸÑ", medium:"ŸÖÿ™Ÿàÿ≥ÿ∑", hard:"ÿµÿπÿ®", expert:"ÿÆÿ®Ÿäÿ±", qs:"ÿ≥ÿ§ÿßŸÑ" },
            en: { settings: "Settings", teams: "Teams", groups: "Level", start: "Start", spin: "Spin", turn: "Turn", team: "Team", results: "Results", easy:"Easy", medium:"Medium", hard:"Hard", expert:"Expert", qs:"Q" },
            fr: { settings: "Param√®tres", teams: "√âquipes", groups: "Niveau", start: "Commencer", spin: "Tourner", turn: "Tour", team: "√âquipe", results: "R√©sultats", easy:"Facile", medium:"Moyen", hard:"Difficile", expert:"Expert", qs:"Q" }
        };

        const difficultyMap = { 1: "easy", 2: "medium", 3: "hard", 4: "expert" };

        // =====================================
        // STATE
        // =====================================
        let selectedLangs = new Set(['ar']); 
        let activeLangArray = []; 
        let currentQuestions = []; 
        let selectedGroups = new Set();
        let numTeams = 1;
        let scores = [0, 0, 0, 0];
        let currentTeamIndex = 0;
        let audioCtx = null;
        
        const levelColors = { 1: "#2ecc71", 2: "#f1c40f", 3: "#e67e22", 4: "#e74c3c" };

        // =====================================
        // 1. LANGUAGE SELECTION
        // =====================================
        function toggleLang(lang) {
            const btn = document.getElementById(`lang-${lang}`);
            if (selectedLangs.has(lang)) {
                if (selectedLangs.size > 1) {
                    selectedLangs.delete(lang);
                    btn.classList.remove('active');
                }
            } else {
                selectedLangs.add(lang);
                btn.classList.add('active');
            }
        }

        function getMultiLangText(key) {
            return activeLangArray.map(l => uiText[l][key]).join(' / ');
        }

        function goToIntro() {
            if (typeof gameData === 'undefined') { alert("Error: questions.js not loaded."); return; }
            activeLangArray = Array.from(selectedLangs);
            
            // Apply text
            document.getElementById('ui-title').innerText = getMultiLangText('settings');
            document.getElementById('ui-teams').innerText = getMultiLangText('teams');
            document.getElementById('ui-groups').innerText = getMultiLangText('groups');
            document.getElementById('startBtn').innerText = getMultiLangText('start');
            document.getElementById('ui-results').innerText = getMultiLangText('results');
            document.getElementById('spinBtn').innerText = getMultiLangText('spin');

            updateGroupButtons();

            document.getElementById('langScreen').style.display = 'none';
            document.getElementById('introScreen').style.display = 'flex';
        }

        function updateGroupButtons() {
            // Update buttons 1-4
            for(let i=1; i<=4; i++) {
                const btn = document.getElementById(`btn-${i}`);
                
                // 1. Get Difficulty Name in all langs
                const diffKey = difficultyMap[i];
                const label = activeLangArray.map(l => uiText[l][diffKey]).join(' / ');
                
                // 2. Count Questions
                let count = 0;
                activeLangArray.forEach(l => {
                    const qs = gameData[l].filter(q => q.l === i);
                    count += qs.length;
                });
                
                // 3. Set HTML
                const qsLabel = activeLangArray[0] === 'ar' ? 'ÿ≥ÿ§ÿßŸÑ' : 'Qs';
                btn.innerHTML = `${label}<br><span class="group-count">(${count} ${qsLabel})</span>`;
            }
        }

        // =====================================
        // 2. TEAM & GROUP SETUP
        // =====================================
        function selectTeams(n) {
            numTeams = n;
            document.querySelectorAll('.team-btn').forEach((b, i) => {
                if (i + 1 === n) b.classList.add('selected');
                else b.classList.remove('selected');
            });
        }

        function toggleGroup(id) {
            const btn = document.getElementById(`btn-${id}`);
            if (selectedGroups.has(id)) {
                selectedGroups.delete(id);
                btn.classList.remove('selected');
            } else {
                selectedGroups.add(id);
                btn.classList.add('selected');
            }
            document.getElementById('startBtn').disabled = (selectedGroups.size === 0);
        }

        function confirmStart() {
            // Get IDs from first lang
            const masterList = gameData[activeLangArray[0]];
            
            // Filter
            currentQuestions = masterList.filter(q => {
                let g = 0;
                if (q.id <= 25) g = 1;
                else if (q.id <= 50) g = 2;
                else if (q.id <= 75) g = 3;
                else if (q.id <= 100) g = 4;
                return selectedGroups.has(g);
            }).map(q => q.id); 

            if(currentQuestions.length === 0) return;

            // Init Scores
            scores = new Array(numTeams).fill(0);
            currentTeamIndex = 0;
            
            // Build Scoreboard
            const sb = document.getElementById('scoreboard');
            sb.innerHTML = '';
            const teamLabel = getMultiLangText('team');
            for(let i=0; i<numTeams; i++) {
                sb.innerHTML += `
                    <div class="team-card" id="team-card-${i}">
                        <span class="team-name">${teamLabel} ${i+1}</span>
                        <span class="team-score" id="score-${i}">0</span>
                    </div>
                `;
            }

            document.getElementById('introScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'flex';
            
            updateTurnUI();
            drawWheel();
        }

        function updateTurnUI() {
            for(let i=0; i<numTeams; i++) {
                const card = document.getElementById(`team-card-${i}`);
                if(i === currentTeamIndex) card.classList.add('active-turn');
                else card.classList.remove('active-turn');
            }
            const turnLabel = getMultiLangText('turn');
            const teamLabel = getMultiLangText('team');
            document.getElementById('turnMsg').innerText = `${turnLabel}: ${teamLabel} ${currentTeamIndex + 1}`;
        }

        // =====================================
        // 3. WHEEL LOGIC
        // =====================================
        const canvas = document.getElementById('wheelCanvas');
        const ctx = canvas.getContext('2d');
        const size = 1000; const center = size/2; const radius = size/2 - 20;
        let currentDeg = 0;
        let selectedId = -1;

        function drawWheel() {
            if (currentQuestions.length === 0) {
                showGameOver();
                return;
            }

            const sliceDeg = 360 / currentQuestions.length;
            const sliceRad = (sliceDeg * Math.PI) / 180;
            ctx.clearRect(0, 0, size, size);

            for (let i = 0; i < currentQuestions.length; i++) {
                const qId = currentQuestions[i];
                const qData = gameData[activeLangArray[0]].find(q => q.id === qId);
                
                const startAngle = (i * sliceRad) - (Math.PI / 2);
                ctx.beginPath();
                ctx.moveTo(center, center);
                ctx.arc(center, center, radius, startAngle, startAngle + sliceRad);
                ctx.closePath();
                ctx.fillStyle = levelColors[qData.l];
                ctx.fill();
                ctx.strokeStyle = "#2c3e50"; ctx.lineWidth = 2; ctx.stroke();
                
                if(currentQuestions.length <= 60) {
                    ctx.save();
                    ctx.translate(center, center);
                    ctx.rotate(startAngle + sliceRad / 2);
                    ctx.textAlign = "right";
                    ctx.fillStyle = "rgba(0,0,0,0.5)"; 
                    ctx.font = "bold 24px Arial";
                    ctx.fillText(qId, radius - 28, 12);
                    ctx.fillStyle = "#fff"; 
                    ctx.fillText(qId, radius - 30, 10);
                    ctx.restore();
                }
            }
        }

        function spin() {
            if (currentQuestions.length === 0) return;
            initAudio();
            document.getElementById('spinBtn').disabled = true;
            
            const randomIdx = Math.floor(Math.random() * currentQuestions.length);
            selectedId = currentQuestions[randomIdx];

            const sliceDeg = 360 / currentQuestions.length;
            const targetDeg = (randomIdx * sliceDeg); 
            const randomOffset = (Math.random() * sliceDeg * 0.8) - (sliceDeg * 0.4);
            const totalDeg = currentDeg + 1800 + (360 - targetDeg - (currentDeg % 360) + 360)%360 + randomOffset;

            canvas.style.transform = `rotate(${totalDeg}deg)`;
            canvas.style.transition = "transform 4s cubic-bezier(0.25, 0.1, 0.25, 1)";
            currentDeg = totalDeg;

            let duration = 4000; let start = Date.now();
            function tick() {
                if(Date.now()-start > duration) return;
                playTick();
                setTimeout(tick, 50 + ((Date.now()-start)/duration)**2 * 500);
            }
            tick();

            setTimeout(() => {
                openMultiLangQuestion(selectedId); 
                document.getElementById('spinBtn').disabled = false;
            }, 4000);
        }

        // =====================================
        // 4. MULTI-LANGUAGE MODAL LOGIC
        // =====================================
        function openMultiLangQuestion(id) {
            const modal = document.getElementById('modal');
            const qContainer = document.getElementById('mQuestionContainer');
            const optDiv = document.getElementById('mOptions');
            const refBox = document.getElementById('mReference');
            
            qContainer.innerHTML = "";
            optDiv.innerHTML = "";
            refBox.innerHTML = "";
            document.getElementById('closeBtn').style.display = 'none';
            document.getElementById('mReference').style.display = 'none';

            // Gather Data
            let qSet = activeLangArray.map(lang => {
                return { lang: lang, data: gameData[lang].find(q => q.id === id) };
            });

            // Set Badge
            const firstQ = qSet[0].data;
            document.getElementById('mLevel').innerText = `Level ${firstQ.l}`;
            document.getElementById('mLevel').style.background = levelColors[firstQ.l];

            // Render Questions
            qSet.forEach(item => {
                const div = document.createElement('div');
                div.className = 'q-text-item';
                div.setAttribute('lang', item.lang);
                div.setAttribute('dir', item.lang === 'ar' ? 'rtl' : 'ltr');
                div.innerText = item.data.t;
                qContainer.appendChild(div);
            });

            // Render Options
            let indices = [0, 1, 2, 3];
            for (let i = indices.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [indices[i], indices[j]] = [indices[j], indices[i]];
            }

            indices.forEach(idx => {
                const btn = document.createElement('button');
                btn.className = "opt-btn";
                qSet.forEach(item => {
                    const span = document.createElement('span');
                    span.className = 'opt-subtext';
                    span.innerText = item.data.o[idx];
                    span.setAttribute('dir', item.lang === 'ar' ? 'rtl' : 'ltr');
                    btn.appendChild(span);
                });

                const isCorrect = (idx === firstQ.c);
                btn.onclick = () => handleAnswer(btn, isCorrect, qSet);
                optDiv.appendChild(btn);
            });

            modal.style.display = 'flex';
        }

        function handleAnswer(btn, isCorrect, qSet) {
            const allBtns = document.querySelectorAll('.opt-btn');
            allBtns.forEach(b => b.disabled = true);

            if(isCorrect) {
                playWin();
                btn.style.background = "#2ecc71"; 
                btn.style.borderColor = "#27ae60";
                scores[currentTeamIndex]++;
                document.getElementById(`score-${currentTeamIndex}`).innerText = scores[currentTeamIndex];
            } else {
                playLoss();
                btn.style.background = "#e74c3c"; 
                btn.style.borderColor = "#c0392b";
            }

            // Show References
            const refBox = document.getElementById('mReference');
            qSet.forEach(item => {
                const div = document.createElement('div');
                div.className = 'ref-item';
                div.setAttribute('dir', item.lang === 'ar' ? 'rtl' : 'ltr');
                const label = item.lang === 'ar' ? 'ÿßŸÑÿ¥ÿßŸáÿØ:' : (item.lang === 'fr' ? 'R√©f:' : 'Ref:');
                div.innerHTML = `<strong>${label}</strong> ${item.data.r}`;
                refBox.appendChild(div);
            });

            refBox.style.display = 'block';
            document.getElementById('closeBtn').style.display = 'inline-block';
            
            const modalBox = document.querySelector('.modal-box');
            setTimeout(() => { modalBox.scrollTop = modalBox.scrollHeight; }, 100);
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            const idxToRemove = currentQuestions.indexOf(selectedId);
            if (idxToRemove !== -1) currentQuestions.splice(idxToRemove, 1);
            
            currentTeamIndex++;
            if(currentTeamIndex >= numTeams) currentTeamIndex = 0;
            updateTurnUI();
            drawWheel();
        }

        function showGameOver() {
            const modal = document.getElementById('gameOverModal');
            const list = document.getElementById('rankList');
            list.innerHTML = "";
            let ranking = scores.map((s, i) => ({ id: i+1, score: s }));
            ranking.sort((a, b) => b.score - a.score);

            const teamLabel = getMultiLangText('team');
            document.getElementById('winnerName').innerText = `üèÜ ${teamLabel} ${ranking[0].id}`;

            ranking.forEach((r, idx) => {
                let badge = idx === 0 ? "ü•á" : (idx === 1 ? "ü•à" : (idx === 2 ? "ü•â" : ""));
                list.innerHTML += `
                    <li class="rank-item">
                        <span>${badge} ${teamLabel} ${r.id}</span>
                        <span>${r.score}</span>
                    </li>
                `;
            });
            modal.style.display = 'flex';
            playWin();
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(e=>{});
            else if (document.exitFullscreen) document.exitFullscreen();
        }

        // =====================================
        // AUDIO
        // =====================================
        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }
        function playTone(f, t, d, v=0.1) {
            if(!audioCtx) return;
            const o=audioCtx.createOscillator(), g=audioCtx.createGain();
            o.type=t; o.frequency.value=f; g.gain.setValueAtTime(v, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime+d);
            o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+d);
        }
        function playTick() { playTone(300,'square',0.05,0.05); }
        function playWin() { 
            playTone(523.25,'sine',0.4,0.2); setTimeout(()=>playTone(659.25,'sine',0.4,0.2),100);
            setTimeout(()=>playTone(783.99,'sine',0.6,0.2),200); setTimeout(()=>playTone(1046.50,'sine',1.0,0.1),300);
        }
        function playLoss() {
            if(!audioCtx) return;
            const o=audioCtx.createOscillator(), g=audioCtx.createGain();
            o.type='sawtooth'; o.frequency.setValueAtTime(150, audioCtx.currentTime);
            o.frequency.linearRampToValueAtTime(50, audioCtx.currentTime+0.5);
            g.gain.setValueAtTime(0.2, audioCtx.currentTime);
            g.gain.linearRampToValueAtTime(0.001, audioCtx.currentTime+0.5);
            o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.5);
        }
    </script>
</body>
</html>
